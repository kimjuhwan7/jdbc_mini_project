package exploiter.controller;

import AgameMain.Main;
import exploiter.Exploiter;
import exploiter.service.ResearchByIdService;
import exploiter.service.UpdateService;
import generic.Encrypt;

public class UpdateController implements Controller {

	private static UpdateController instance;

	public static UpdateController getInstace() {

		if (instance == null) {
			instance = new UpdateController();
		}

		return instance;
	}

	// id 수정 시 기존id와 중복체크, 공백체크 하는 메소드를 InsertController에 구현해놔서 InsertController까지 호출 >> 의존성 증가
	// 체크하는 메소드를 Controller가 아닌 다른 클래스로 빼서 구성하는게 더 좋았을 것 같음 >> 아쉬운 점
	// 삭제 대상 id가 있는지 판별하기 위해 byIdService도 호출. 
	// id중복체크 메소드를 따로 빼서 대체하거나 구현부에서 쿼리문 추가로 대체할 수 있었을 것 같음 >> 아쉬운 점
	UpdateService service = UpdateService.getInstance();
	InsertController insertController = InsertController.getInstance();
	ResearchByIdService byIdService = ResearchByIdService.getInstance();

	String id = null;
	int admin = 0;
	String password = null;
	String nickname = null;
	String targetId = null;
	
	public void process() {
		
		while(true) {
		
			if(Main.user.getAdmin()==1){ // 관리자 -> 모든 회원 수정 가능
				
				try {
				System.out.println("정보를 수정할 회원 ID 를 입력해주세요. -> ");
				
				targetId = Main.sc.nextLine();
				
				if(byIdService.researchById(targetId)==null) {
					throw new Exception();
					
				} else {
					updateProcess();
					System.out.print("일반 회원인 경우 '회원'을, 관리자인 경우 '관리자'를 입력하세요. ->");
					admin = insertController.checkAdmin(admin);
					updateCheck();
					break;
					
				}
					
				} catch(Exception e) {
					System.out.println("존재하지 않는 회원입니다. ");
					break;
				}
			
			} else if(Main.user.getAdmin()==0) { // 회원 -> 본인만 수정 가능
	
				updateProcess();
				admin=0;
				targetId = Main.user.getId();
				updateCheck();
				break;
	
			}
		}
	}
	
	private void updateProcess() {
		
		System.out.println("새로운 id를 입력해주세요.");
		id = insertController.checkId(id);

		System.out.println("새로운 비밀번호를 입력해주세요.");
		password = insertController.checkPassword(password);

		System.out.println("새로운 닉네임을 입력해주세요.");
		nickname = insertController.checkNickname(nickname);
		
	}
	
	private void updateCheck() {

		String salt = Encrypt.getSalt();	// 정보를 수정하면 salt값도 새로 바뀌도록 구성
		int result = service.update(new Exploiter(id, Encrypt.getEncrypt(password, salt), nickname, admin, salt), targetId);

		if (result > 0) {
			System.out.println("수정되었습니다.");
		} else {
			System.out.println("수정 실패");
		}
	}
}
